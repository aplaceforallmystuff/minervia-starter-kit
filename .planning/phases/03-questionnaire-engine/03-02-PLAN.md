---
phase: 03-questionnaire-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [install.sh]
autonomous: true

must_haves:
  truths:
    - "User is presented with interactive questionnaire during installation"
    - "User sees progress through questionnaire (Question X of Y)"
    - "User can review answers and edit specific ones before proceeding"
    - "Questionnaire captures name, vault path, role, key areas, and preferences"
  artifacts:
    - path: "install.sh"
      provides: "Complete questionnaire flow"
      contains: "run_questionnaire"
  key_links:
    - from: "run_questionnaire"
      to: "ask_text/ask_choice/ask_multi"
      via: "function calls"
      pattern: "ask_(text|choice|multi)"
    - from: "confirm_summary"
      to: "edit_answer"
      via: "edit flow"
      pattern: "edit_answer"
    - from: "main flow"
      to: "run_questionnaire"
      via: "conditional call after prerequisites"
      pattern: "run_questionnaire"
---

<objective>
Implement the questionnaire flow with progress indicator, summary with edit capability, and integration into the main installation flow.

Purpose: Capture user context (name, vault path, role, areas, preferences) through interactive prompts that adapt based on Gum availability.

Output: Complete questionnaire that runs after prerequisites, shows progress, allows review/edit, and stores answers for Phase 4 (CLAUDE.md generation).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-questionnaire-engine/03-CONTEXT.md
@.planning/phases/03-questionnaire-engine/03-RESEARCH.md
@.planning/phases/03-questionnaire-engine/03-01-SUMMARY.md
@install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement questionnaire flow with progress indicator</name>
  <files>install.sh</files>
  <action>
Add the questionnaire flow functions after the input functions from Plan 01.

1. Define question options as arrays:
```bash
ROLE_OPTIONS=("Developer" "Designer" "Product Manager" "Consultant" "Writer" "Researcher" "Other")
AREA_OPTIONS=("Software Development" "Content Creation" "Research" "Consulting" "Project Management" "Learning" "Personal")
PREF_OPTIONS=("Concise responses" "Detailed explanations" "Step-by-step guidance" "Direct communication" "Socratic questioning")
```

2. Create show_progress() function:
   - Increment CURRENT_QUESTION
   - With Gum: `gum style --foreground 99 "Question $CURRENT_QUESTION of $TOTAL_QUESTIONS"`
   - Fallback: echo in YELLOW "--- Question $CURRENT_QUESTION of $TOTAL_QUESTIONS ---"

3. Create run_questionnaire() function that:
   - Initializes CURRENT_QUESTION=0, TOTAL_QUESTIONS=5
   - Prints welcome message ("Let's personalize your Minervia installation")

   - **Question 1 (Name):**
     - show_progress
     - "What should Claude call you?"
     - Use ask_text with required=true
     - Store in ANSWERS[name]

   - **Question 2 (Vault Path):**
     - show_progress
     - "Where is your Obsidian vault? (Enter full path)"
     - Use ask_text with required=true
     - Validate path: if not exists, ask_confirm to create it
     - If create confirmed: mkdir -p or show error
     - Store in ANSWERS[vault_path]

   - **Question 3 (Role):**
     - show_progress
     - "What best describes your role?"
     - Use ask_choice with ROLE_OPTIONS
     - If "Other" selected: ask_text for custom role
     - Store in ANSWERS[role]

   - **Question 4 (Key Areas):**
     - show_progress
     - "What areas do you focus on? (Select multiple)"
     - Use ask_multi with AREA_OPTIONS
     - Convert newlines to commas, remove trailing comma
     - Store in ANSWERS[areas]

   - **Question 5 (Preferences):**
     - show_progress
     - "How do you prefer Claude to communicate?"
     - Use ask_multi with PREF_OPTIONS
     - Convert newlines to commas, remove trailing comma
     - Store in ANSWERS[preferences]

Reference RESEARCH.md "Complete Questionnaire Flow" for exact implementation.

Important:
- Always quote "${ANSWERS[...]}" to handle spaces in paths
- Convert multi-select output: `$(... | tr '\n' ',')` then `${var%,}` to remove trailing comma
  </action>
  <verify>
Source the script and call run_questionnaire manually:
```bash
source install.sh
run_questionnaire
echo "Name: ${ANSWERS[name]}"
echo "Path: ${ANSWERS[vault_path]}"
```
  </verify>
  <done>
run_questionnaire function exists with 5 questions, progress indicator shows "Question X of 5", all answers stored in ANSWERS array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add summary with edit capability</name>
  <files>install.sh</files>
  <action>
Add summary and edit functions after run_questionnaire.

1. Create show_summary() function:
   - Print styled header ("Summary" with border if Gum, plain divider if not)
   - Display all answers with numbers:
     ```
     1) Name:        ${ANSWERS[name]}
     2) Vault path:  ${ANSWERS[vault_path]}
     3) Role:        ${ANSWERS[role]}
     4) Key areas:   ${ANSWERS[areas]:-None selected}
     5) Preferences: ${ANSWERS[preferences]:-None selected}
     ```

2. Create edit_answer() function that takes field number/name:
   - Case statement matching 1/name, 2/vault_path, 3/role, 4/areas, 5/preferences
   - Re-run the appropriate ask_* function for that field
   - Update ANSWERS with new value

3. Create confirm_summary() function:
   - Loop:
     - Call show_summary
     - With Gum: `gum choose "Continue" "Edit answer" "Start over"`
     - Fallback: Menu with c/e/r options
     - If "Continue": return 0
     - If "Edit answer":
       - With Gum: `gum choose "1) Name" "2) Vault path" ...`
       - Fallback: "Which field to edit (1-5)?"
       - Call edit_answer with selection
       - Loop continues (shows summary again)
     - If "Start over": return 1 (caller restarts questionnaire)

4. Update run_questionnaire to call confirm_summary at the end:
```bash
if ! confirm_summary; then
    # User chose "Start over"
    run_questionnaire
    return
fi
```

Reference RESEARCH.md Pattern 6 for implementation details.
  </action>
  <verify>
After running questionnaire, summary displays correctly with all 5 answers.
Selecting "Edit answer" -> "1) Name" allows re-entering name.
Selecting "Continue" proceeds without loop.
  </verify>
  <done>
show_summary displays all answers, edit_answer modifies specific fields, confirm_summary offers Continue/Edit/Start over options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate questionnaire into main installation flow</name>
  <files>install.sh</files>
  <action>
Wire the questionnaire into the main installation flow.

1. Move CLI flag values into ANSWERS array after it's declared:
   - After `declare -A ANSWERS` (which comes after check_prerequisites), add:
   ```bash
   # Copy CLI flags to ANSWERS array (for non-interactive mode)
   [[ -n "${CLI_NAME:-}" ]] && ANSWERS[name]="$CLI_NAME"
   [[ -n "${CLI_VAULT_PATH:-}" ]] && ANSWERS[vault_path]="$CLI_VAULT_PATH"
   [[ -n "${CLI_ROLE:-}" ]] && ANSWERS[role]="$CLI_ROLE"
   [[ -n "${CLI_AREAS:-}" ]] && ANSWERS[areas]="$CLI_AREAS"
   [[ -n "${CLI_PREFERENCES:-}" ]] && ANSWERS[preferences]="$CLI_PREFERENCES"
   ```

2. Add questionnaire orchestration after check_prerequisites:
   ```bash
   # Gum detection and install offer
   offer_gum_install

   # Run questionnaire (interactive or skip if flags provided)
   if [[ "${SKIP_QUESTIONNAIRE:-false}" == "true" ]]; then
       echo "Skipping questionnaire (--no-questionnaire)"
       # Validate required fields
       if [[ -z "${ANSWERS[name]:-}" ]] || [[ -z "${ANSWERS[vault_path]:-}" ]]; then
           error_exit "Non-interactive mode requires --name and --vault-path" \
               "Run with: ./install.sh --name \"Your Name\" --vault-path \"/path/to/vault\""
       fi
   elif ! is_interactive; then
       echo "Non-interactive mode detected."
       if [[ -z "${ANSWERS[name]:-}" ]] || [[ -z "${ANSWERS[vault_path]:-}" ]]; then
           error_exit "Non-interactive mode requires --name and --vault-path" \
               "Run with: ./install.sh --name \"Your Name\" --vault-path \"/path/to/vault\""
       fi
   else
       run_questionnaire
   fi
   ```

3. Update VAULT_DIR to use questionnaire answer:
   - Change `VAULT_DIR="$(pwd)"` to `VAULT_DIR="${ANSWERS[vault_path]:-$(pwd)}"`
   - This preserves backward compatibility if questionnaire is skipped

4. Remove the existing "Minervia Setup" echo at the top since the questionnaire will provide its own flow.

5. Add a transition message after questionnaire:
   ```bash
   echo ""
   echo "Installing Minervia..."
   echo ""
   ```

Important:
- The questionnaire runs AFTER check_prerequisites (Bash version validated)
- The questionnaire runs BEFORE vault operations
- Preserve all existing installation logic, just set VAULT_DIR from ANSWERS
  </action>
  <verify>
1. Run `./install.sh` - questionnaire appears, answers are captured
2. Run `./install.sh --no-questionnaire --name "Test" --vault-path "/tmp/test-vault"` - skips questionnaire
3. Run in non-TTY: `echo "" | ./install.sh --name "Test" --vault-path "/tmp/test-vault"` - works
4. Run without required flags in non-interactive: shows error with instructions
  </verify>
  <done>
Questionnaire runs after prerequisites, answers flow to VAULT_DIR, non-interactive mode validates required fields, installation proceeds with captured answers.
  </done>
</task>

</tasks>

<verification>
Full installation flow test:
1. `./install.sh` presents questionnaire with 5 questions
2. Progress shows "Question 1 of 5" through "Question 5 of 5"
3. Summary displays at end with edit option
4. Installation proceeds with vault path from questionnaire
5. Non-interactive mode works with flags
6. Error handling for missing required fields in non-interactive mode
</verification>

<success_criteria>
- User is presented with interactive questionnaire during installation
- Questionnaire captures all 5 required fields (name, vault path, role, areas, preferences)
- Progress indicator shows current question number
- Summary allows reviewing and editing answers before proceeding
- Non-interactive mode works with CLI flags
- VAULT_DIR uses questionnaire answer instead of pwd
- Requirements ONBD-01 and ONBD-02 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-questionnaire-engine/03-02-SUMMARY.md`
</output>
