---
phase: 03-questionnaire-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [install.sh]
autonomous: true

must_haves:
  truths:
    - "Gum is detected if available and user is offered installation if missing"
    - "Input functions work with Gum when available, fallback to read -p when not"
    - "CLI flags allow non-interactive mode for automation/CI"
  artifacts:
    - path: "install.sh"
      provides: "Questionnaire infrastructure"
      contains: "declare -A ANSWERS"
  key_links:
    - from: "ask_text/ask_choice/ask_multi/ask_confirm"
      to: "HAS_GUM variable"
      via: "conditional execution"
      pattern: 'if \$HAS_GUM'
    - from: "parse_args"
      to: "ANSWERS array"
      via: "flag storage"
      pattern: 'ANSWERS\[.*\]='
---

<objective>
Add questionnaire infrastructure: Gum detection with install offer, dual-mode input functions, and CLI flags for non-interactive operation.

Purpose: Build the foundation that the questionnaire flow will use. This enables both enhanced Gum experience and graceful fallback to basic prompts.

Output: install.sh extended with Gum detection, ANSWERS array, ask_* functions, and --name/--vault-path/--role flags.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-questionnaire-engine/03-CONTEXT.md
@.planning/phases/03-questionnaire-engine/03-RESEARCH.md
@install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Gum detection and ANSWERS array initialization</name>
  <files>install.sh</files>
  <action>
Add after the VERSION constant and before show_help():

1. Initialize HAS_GUM variable (false by default)
2. Create check_gum() function that sets HAS_GUM=true if `command -v gum` succeeds
3. Create offer_gum_install() function that:
   - Calls check_gum and returns if already available
   - Prints friendly message about Gum providing better experience
   - Uses read -p to ask "Install Gum for a better experience? (y/N)"
   - If yes and Homebrew available: runs `brew install gum`, sets HAS_GUM=true on success
   - If Homebrew unavailable: shows URL and continues with basic prompts
   - If no: continues with basic prompts
4. Initialize ANSWERS associative array: `declare -A ANSWERS`

Place the `declare -A ANSWERS` AFTER the Bash version check runs (since associative arrays require Bash 4.0+). Add it right after check_prerequisites is called.

Pattern from RESEARCH.md:
```bash
HAS_GUM=false

check_gum() {
    if command -v gum &> /dev/null; then
        HAS_GUM=true
        return 0
    fi
    return 1
}
```
  </action>
  <verify>
Run `./install.sh --help` still works.
Run `bash -c 'source install.sh 2>/dev/null; type check_gum'` confirms function exists.
  </verify>
  <done>
HAS_GUM variable defined, check_gum() and offer_gum_install() functions exist, ANSWERS array initialized after prerequisites.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dual-mode input functions</name>
  <files>install.sh</files>
  <action>
Add four input functions after offer_gum_install(). Each function checks HAS_GUM and uses Gum when available, falls back to read -p otherwise.

1. **ask_text(prompt, placeholder, required)** - Single-line text input
   - With Gum: `gum input --placeholder "$placeholder" --prompt "$prompt "`
   - Fallback: `read -p "$prompt " result`
   - If required=true and empty: print error in RED, re-prompt (max 3 retries via loop)
   - Returns: the entered text via echo

2. **ask_choice(prompt, options...)** - Single selection from list
   - With Gum: `gum choose --header "$prompt" "${options[@]}"`
   - Fallback: Number menu (1-N), validate input is valid number
   - Returns: the selected option text

3. **ask_multi(prompt, options...)** - Multi-select (Tab to select with Gum)
   - With Gum: `printf '%s\n' "${options[@]}" | gum filter --no-limit --header "$prompt"`
   - Fallback: "Enter comma-separated numbers (e.g., 1,3,4)", parse and validate
   - Returns: newline-separated selected options (caller converts to comma-separated if needed)

4. **ask_confirm(prompt, default)** - Yes/No question
   - With Gum: `gum confirm "$prompt"` with --default=yes if default="y"
   - Fallback: read -p with (Y/n) or (y/N) based on default
   - Returns: exit code 0 for yes, 1 for no (use `if ask_confirm "..."; then`)

Important:
- All functions should handle empty input gracefully
- Use MAX_RETRIES=3 for required field validation
- Quote all variables, especially results that might have spaces
- Convert multi-select newlines to comma-separated in the calling code, not in the function

Reference RESEARCH.md Pattern 2 for implementation details.
  </action>
  <verify>
Test functions manually in bash:
```bash
source install.sh
ask_text "Name:" "e.g., John" false
ask_choice "Pick:" "Option A" "Option B"
```
  </verify>
  <done>
Four input functions exist (ask_text, ask_choice, ask_multi, ask_confirm) that use Gum when HAS_GUM=true and fall back to read -p otherwise.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI flags for non-interactive mode</name>
  <files>install.sh</files>
  <action>
Extend parse_args() to support questionnaire flags for CI/automation:

1. Add these flags to the case statement:
   - `--name NAME` - Store in ANSWERS[name]
   - `--vault-path PATH` - Store in ANSWERS[vault_path]
   - `--role ROLE` - Store in ANSWERS[role]
   - `--areas AREAS` - Store in ANSWERS[areas] (comma-separated)
   - `--preferences PREFS` - Store in ANSWERS[preferences] (comma-separated)
   - `--no-questionnaire` - Set SKIP_QUESTIONNAIRE=true

2. Add is_interactive() function:
```bash
is_interactive() {
    [ -t 0 ]
}
```

3. Update show_help() to document the new flags under a "Non-Interactive Mode:" section (see RESEARCH.md help text pattern)

Important:
- Each flag that takes a value needs `shift` after storing
- Initialize SKIP_QUESTIONNAIRE=false before parse_args
- ANSWERS array must be declared before parse_args runs (but it's declared after check_prerequisites, so we need to move the declaration to before parse_args OR handle this in Plan 02 integration)

Actually, looking at the script flow:
- parse_args runs at line 90, before check_prerequisites
- ANSWERS needs Bash 4.0+ (associative array)
- We can't declare ANSWERS before Bash version check

Solution: In parse_args, store flags in regular variables first (e.g., CLI_NAME, CLI_VAULT_PATH), then copy them to ANSWERS after the array is declared. This happens in Plan 02 integration.

For now:
- Add the flag parsing with temporary variables (CLI_NAME, etc.)
- Add is_interactive() function
- Add SKIP_QUESTIONNAIRE variable
- Update help text
  </action>
  <verify>
Run `./install.sh --help` shows new flags documented.
Run `./install.sh --name "Test" --vault-path "/tmp/test" --help` still shows help (help exits early).
  </verify>
  <done>
parse_args handles --name, --vault-path, --role, --areas, --preferences, --no-questionnaire flags. is_interactive() function exists. Help text documents non-interactive mode.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `./install.sh --help` displays new Non-Interactive Mode section
2. `./install.sh --version` still works
3. Script doesn't error when sourced in Bash 4.0+
4. Functions check_gum, offer_gum_install, ask_text, ask_choice, ask_multi, ask_confirm, is_interactive exist
5. Variables HAS_GUM, SKIP_QUESTIONNAIRE are defined
</verification>

<success_criteria>
- Gum detection and install offer ready for use
- All four input functions implemented with dual-mode support
- CLI flags parsed and stored for non-interactive operation
- Help text updated with new options
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-questionnaire-engine/03-01-SUMMARY.md`
</output>
