---
phase: 02-cli-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [install.sh]
autonomous: true

must_haves:
  truths:
    - "Installer checks Bash version and fails with clear message if < 4.0"
    - "Installer checks for Claude Code CLI and fails with installation link"
    - "Installer checks write permissions before any file operations"
    - "All prerequisite checks run after argument parsing"
  artifacts:
    - path: "install.sh"
      provides: "check_bash_version, check_prerequisites functions"
      contains: "BASH_VERSINFO"
  key_links:
    - from: "check_prerequisites"
      to: "error_exit"
      via: "function calls on failure"
      pattern: "error_exit.*Bash.*required"
---

<objective>
Refactor prerequisite checking into organized functions and add Bash version validation.

Purpose: The installer should validate the environment before proceeding. Currently, Claude CLI and write permission checks exist but are scattered. This plan consolidates them into a check_prerequisites function and adds the missing Bash version check using BASH_VERSINFO.

Output: install.sh validates Bash 4.0+, Claude CLI, and write permissions in an organized check_prerequisites flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-interface/02-RESEARCH.md
@install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bash version check function</name>
  <files>install.sh</files>
  <action>
Add check_bash_version function after the portable command wrappers section (after portable_stat_mtime), before the "Main Installation" section.

```bash
# ============================================================================
# Prerequisite Checks
# ============================================================================

# Check Bash version (4.0+ required for associative arrays and other features)
check_bash_version() {
    local min_major=4
    local min_minor=0

    # BASH_VERSINFO is a built-in array: [0]=major, [1]=minor, [2]=patch
    if [[ -z "${BASH_VERSINFO[0]:-}" ]]; then
        error_exit "Cannot determine Bash version" \
            "Ensure you are running this script with Bash"
    fi

    local current_major="${BASH_VERSINFO[0]}"
    local current_minor="${BASH_VERSINFO[1]}"

    if [[ $current_major -lt $min_major ]] || \
       [[ $current_major -eq $min_major && $current_minor -lt $min_minor ]]; then
        error_exit "Bash ${min_major}.${min_minor}+ required (found ${BASH_VERSION})" \
            "Upgrade Bash: brew install bash (macOS) or apt install bash (Linux)"
    fi
}
```

Key points:
- Uses BASH_VERSINFO array (built-in, reliable) not string parsing
- Requires 4.0+ because later phases will use associative arrays
- Clear error message with platform-specific upgrade instructions
  </action>
  <verify>Add a temporary test at the script start: `BASH_VERSINFO=(3 2 0); check_bash_version` - should error. Remove test after verifying.</verify>
  <done>check_bash_version function exists and validates Bash 4.0+ using BASH_VERSINFO</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate prerequisite checks into orchestration function</name>
  <files>install.sh</files>
  <action>
1. **Add check_claude_cli function** (extracting existing logic):
```bash
# Check for Claude Code CLI
check_claude_cli() {
    if ! command -v claude &> /dev/null; then
        error_exit "Claude Code CLI not found" \
            "Install from https://claude.ai/download"
    fi
}
```

2. **Add check_write_permissions function** (keep generic, called with specific dir):
```bash
# Check write permissions for a directory
check_write_permissions() {
    local target_dir="$1"
    if [[ ! -w "$target_dir" ]]; then
        error_exit "Cannot write to directory: $target_dir" \
            "Check permissions or run from a different location"
    fi
}
```

3. **Add check_prerequisites orchestration function**:
```bash
# Run all prerequisite checks
# Called AFTER argument parsing so --help works without prerequisites
check_prerequisites() {
    check_bash_version
    check_claude_cli
    # Write permissions checked later when we know VAULT_DIR
}
```

4. **Update Main Installation section**:
- Remove the existing check_command function and its call for claude
- Remove the inline write permissions check (lines 135-137 approximately)
- Add call to check_prerequisites() after the banner output
- Keep check_write_permissions call but move it after VAULT_DIR is set

The new flow in Main Installation should be:
```bash
echo "Minervia Setup"
echo "=============="
echo ""

check_prerequisites

echo -e "${GREEN}âœ“${NC} Prerequisites validated"
echo ""

# Detect the vault directory
VAULT_DIR="$(pwd)"
SKILLS_SOURCE="$(dirname "$0")/skills"

# Validate write permissions to vault directory
check_write_permissions "$VAULT_DIR"
```

Note: The existing check_command function can stay for optional tools (git, jq), or you can inline those checks. The key change is that Claude CLI check now uses error_exit via check_claude_cli.
  </action>
  <verify>Run `./install.sh` in a directory without claude CLI available (if possible) or verify the function exists with grep. Run `./install.sh` normally and verify "Prerequisites validated" message appears.</verify>
  <done>check_prerequisites orchestrates bash version and claude CLI checks, write permissions checked after VAULT_DIR known, all checks use error_exit for consistent messaging</done>
</task>

</tasks>

<verification>
1. `grep -n "check_bash_version\|check_claude_cli\|check_prerequisites" install.sh` - All functions exist
2. `grep "BASH_VERSINFO" install.sh` - Bash version check uses built-in array
3. `./install.sh` - Runs successfully with "Prerequisites validated" message
4. Help text (`./install.sh --help`) still works without running prerequisite checks
5. Bash version check correctly fails if version too low (test manually if possible)
</verification>

<success_criteria>
- check_bash_version validates Bash 4.0+ using BASH_VERSINFO
- check_claude_cli uses error_exit with download link
- check_prerequisites orchestrates checks after argument parsing
- Write permissions checked after VAULT_DIR is determined
- All checks produce actionable error messages on failure
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-interface/02-02-SUMMARY.md`
</output>
