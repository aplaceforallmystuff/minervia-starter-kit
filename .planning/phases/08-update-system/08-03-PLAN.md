---
phase: 08-update-system
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - skills/minervia-update/SKILL.md
  - skills/minervia-restore/SKILL.md
  - minervia-update.sh
autonomous: false

must_haves:
  truths:
    - "/minervia:update command invokes the update script"
    - "/minervia:restore command allows listing and restoring backups"
    - "Update script is installed to accessible location"
    - "Skills are registered in installer for future installations"
  artifacts:
    - path: "skills/minervia-update/SKILL.md"
      provides: "Update skill for Claude Code"
      min_lines: 40
    - path: "skills/minervia-restore/SKILL.md"
      provides: "Restore skill for Claude Code"
      min_lines: 30
  key_links:
    - from: "skills/minervia-update/SKILL.md"
      to: "~/.minervia/bin/minervia-update.sh"
      via: "bash command"
      pattern: "bash.*minervia-update.sh"
    - from: "install.sh"
      to: "minervia-update.sh"
      via: "copy to bin directory"
      pattern: "cp.*minervia-update.sh"
---

<objective>
Create the /minervia:update and /minervia:restore skills, and wire the update script into the installation process.

Purpose: Make the update system accessible via Claude Code skill commands and ensure the update script is installed to a known location during installation.

Output: Working /minervia:update and /minervia:restore skills that invoke the update script, with proper installation integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-update-system/08-CONTEXT.md
@.planning/phases/08-update-system/08-02-SUMMARY.md
@skills/log-to-daily/SKILL.md (reference for skill format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /minervia:update skill</name>
  <files>skills/minervia-update/SKILL.md</files>
  <action>
Create skills/minervia-update/ directory and SKILL.md:

```markdown
---
name: minervia-update
description: Update Minervia to the latest version while preserving your customizations. Creates backups, shows what's new, lets you choose how to handle conflicts. Use when you want the latest skills and improvements.
use_when: User wants to update Minervia, get latest skills, check for updates, or upgrade their installation.
allowed_tools: Bash, Read
---

# Update Minervia

Check for updates and apply them safely while preserving your customizations.

## Why This Matters

Minervia evolves with new skills, bug fixes, and improvements. The update system:
- Detects files you've customized (via checksum comparison)
- Preserves your changes unless you choose to overwrite
- Creates backups before any modifications
- Shows what's new between versions

## Quick Start

Run the update:

```bash
bash ~/.minervia/bin/minervia-update.sh
```

Or preview changes first:

```bash
bash ~/.minervia/bin/minervia-update.sh --dry-run
```

## What Happens During Update

1. **Version check** - Compares installed version to latest on GitHub
2. **Changelog** - Shows what's new since your version
3. **Customization scan** - Identifies files you've modified
4. **Conflict resolution** - For each customized file, you choose:
   - Keep mine (skip this file)
   - Take theirs (use new version)
   - Backup + overwrite (save yours, use new)
5. **Backup** - Creates timestamped backup of all tracked files
6. **Update** - Applies changes to non-customized files
7. **Report** - Shows what was updated

## Options

| Flag | Effect |
|------|--------|
| `--dry-run` | Show what would change without applying |
| `-v, --verbose` | Show detailed file-by-file actions |
| `--list-backups` | Show available backups |
| `--restore TIMESTAMP` | Restore from a specific backup |

## Backups

Backups are stored in `~/.minervia/backups/` with timestamped folders:
- `2026-01-18T10-30-00/` contains all tracked files as of that update
- Backups are kept forever (no auto-pruning)

To restore from a backup:
```bash
bash ~/.minervia/bin/minervia-update.sh --restore 2026-01-18T10-30-00
```

## Process for Claude

1. Check if update script exists: `ls ~/.minervia/bin/minervia-update.sh`
2. If missing, inform user to reinstall Minervia
3. Run update with appropriate flags based on user request
4. Report results to user

## Success Criteria

- [ ] Update script executed successfully
- [ ] User informed of version changes
- [ ] Customized files handled per user preference
- [ ] Backup created before modifications
```
  </action>
  <verify>
Verify skill file:
```bash
cat skills/minervia-update/SKILL.md
# Check frontmatter is valid
head -10 skills/minervia-update/SKILL.md
```
  </verify>
  <done>skills/minervia-update/SKILL.md exists with complete documentation for the update command</done>
</task>

<task type="auto">
  <name>Task 2: Create /minervia:restore skill</name>
  <files>skills/minervia-restore/SKILL.md</files>
  <action>
Create skills/minervia-restore/ directory and SKILL.md:

```markdown
---
name: minervia-restore
description: List and restore from Minervia backups. Shows available backup timestamps and lets you restore files to previous versions. Use when you need to undo an update or recover customizations.
use_when: User wants to restore from backup, undo an update, recover previous file versions, or list available backups.
allowed_tools: Bash, Read
---

# Restore from Backup

List available backups and restore files to previous versions.

## Why This Matters

Updates create backups automatically. If something goes wrong or you prefer your previous configuration, you can restore:
- All files from a specific backup
- Recover customizations that were overwritten
- Undo an update completely

## Quick Start

List available backups:

```bash
bash ~/.minervia/bin/minervia-update.sh --list-backups
```

Restore from a specific backup:

```bash
bash ~/.minervia/bin/minervia-update.sh --restore 2026-01-18T10-30-00
```

## What You'll See

```
Available backups:

  2026-01-18T10-30-00 (15 files)
  2026-01-15T14-22-33 (12 files)

To restore: ./minervia-update.sh --restore TIMESTAMP
```

## Restore Process

1. **Select backup** - Choose a timestamp from the list
2. **Preview files** - See which files will be restored
3. **Confirm** - Approve the restoration
4. **Restore** - Files copied back to original locations

## Important Notes

- Restoring overwrites current files with backup versions
- Consider creating a backup before restoring (run update first)
- Backups are stored in `~/.minervia/backups/`
- Backups are kept forever (no auto-pruning)

## Process for Claude

1. List backups: `bash ~/.minervia/bin/minervia-update.sh --list-backups`
2. If user specifies a timestamp, restore: `bash ~/.minervia/bin/minervia-update.sh --restore TIMESTAMP`
3. If no backups exist, inform user that backups are created during updates

## Success Criteria

- [ ] Backups listed or restored as requested
- [ ] User informed of restoration results
- [ ] Files restored to correct locations
```
  </action>
  <verify>
Verify skill file:
```bash
cat skills/minervia-restore/SKILL.md
# Check frontmatter is valid
head -10 skills/minervia-restore/SKILL.md
```
  </verify>
  <done>skills/minervia-restore/SKILL.md exists with documentation for backup listing and restoration</done>
</task>

<task type="auto">
  <name>Task 3: Wire update script into installation</name>
  <files>minervia-update.sh, install.sh</files>
  <action>
**Update minervia-update.sh:**

1. Update the header comment to include installation path:
```bash
# ============================================================================
# Minervia Update Utility
# ============================================================================
# Installed to: ~/.minervia/bin/minervia-update.sh
# Invoked via: /minervia:update skill or directly
# ============================================================================
```

2. Add self-location detection at the top (after constants):
```bash
# Detect script location (works whether invoked from repo or ~/.minervia/bin)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
```

**Update install.sh:**

Add update script installation after skills installation (after the do_install_agents wrapper, around line 1760):

```bash
# ============================================================================
# Update Script Installation
# ============================================================================

# Install update script to ~/.minervia/bin/
install_update_script() {
    local source_script="$(dirname "$0")/minervia-update.sh"
    local target_dir="$HOME/.minervia/bin"
    local target_script="$target_dir/minervia-update.sh"

    if [[ ! -f "$source_script" ]]; then
        verbose "Update script not found in source directory"
        return 0
    fi

    # Create bin directory
    if ! mkdir -p "$target_dir" 2>/dev/null; then
        echo -e "${YELLOW}!${NC} Could not create $target_dir"
        return 1
    fi

    # Copy update script
    if cp "$source_script" "$target_script" 2>/dev/null; then
        chmod +x "$target_script"
        echo -e "${GREEN}âœ“${NC} Update script installed"
        verbose "  Location: $target_script"
        return 0
    else
        echo -e "${YELLOW}!${NC} Failed to install update script"
        return 1
    fi
}
```

Add step constant (with other STEP_* constants around line 685):
```bash
STEP_UPDATE_SCRIPT="update_script"
```

Add wrapper function (after do_generate_claudemd wrapper):
```bash
# Wrapper for update script installation step
do_install_update_script() {
    install_update_script
}
```

Add to main installation flow (after run_step for agents, around line 1904):
```bash
run_step "$STEP_UPDATE_SCRIPT" "Installing update script" do_install_update_script
```

Update show_help() to mention the update command:
```
Update:
  After installation, you can update Minervia:
  bash ~/.minervia/bin/minervia-update.sh

  Or use the /minervia:update skill in Claude Code.
```
  </action>
  <verify>
Verify installation integration:
```bash
# Check update script will be installed
grep -n "install_update_script" install.sh
grep -n "STEP_UPDATE_SCRIPT" install.sh

# Test installation (in a test directory)
# After running install.sh:
ls -la ~/.minervia/bin/minervia-update.sh
```
  </verify>
  <done>install.sh installs minervia-update.sh to ~/.minervia/bin/, help mentions update command</done>
</task>

</tasks>

<verification>
After all tasks:
1. skills/minervia-update/SKILL.md exists with valid frontmatter
2. skills/minervia-restore/SKILL.md exists with valid frontmatter
3. install.sh has install_update_script function
4. Run install.sh, verify ~/.minervia/bin/minervia-update.sh exists and is executable
5. Running /minervia:update in Claude Code shows skill help
</verification>

<success_criteria>
- [ ] /minervia:update skill documents update workflow
- [ ] /minervia:restore skill documents backup restoration
- [ ] install.sh installs update script to ~/.minervia/bin/
- [ ] Update script is executable after installation
- [ ] Help output mentions update capability
- [ ] Skills use allowed_tools: Bash, Read
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete update system with skills and installation integration</what-built>
  <how-to-verify>
1. Run `./install.sh` in a test vault
2. Verify ~/.minervia/bin/minervia-update.sh exists
3. Run `bash ~/.minervia/bin/minervia-update.sh --help`
4. Run `bash ~/.minervia/bin/minervia-update.sh --dry-run`
5. Check skills installed to ~/.claude/skills/minervia-update/ and minervia-restore/
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/08-update-system/08-03-SUMMARY.md`
</output>
