---
phase: 04-claudemd-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - "CLAUDE.md is generated in vault root with user's questionnaire answers populated"
    - "User sees 'Detected: new vault' or 'Detected: existing vault' message"
    - "For existing CLAUDE.md, user sees diff and is prompted before any changes"
    - "Backup is created with timestamp when user chooses 'Backup and replace'"
  artifacts:
    - path: "install.sh"
      provides: "Complete CLAUDE.md generation flow"
      contains: "handle_existing_claudemd"
  key_links:
    - from: "install.sh main flow"
      to: "detect_vault_type"
      via: "function call after cd to VAULT_DIR"
      pattern: "detect_vault_type"
    - from: "install.sh main flow"
      to: "process_template"
      via: "function call with template path"
      pattern: "process_template.*TEMPLATE_DIR"
    - from: "handle_existing_claudemd"
      to: "diff -u"
      via: "show_colored_diff function"
      pattern: "diff -u"
---

<objective>
Replace heredoc CLAUDE.md generation with template-based system and add existing file handling

Purpose: Complete the CLAUDE.md generation flow by replacing the static heredoc with personalized template processing, and adding proper handling for existing files (diff display, user prompts, backup creation).

Output:
- Personalized CLAUDE.md generated from template with user answers
- New/existing vault detection with user feedback
- Diff display and action menu for existing CLAUDE.md
- Timestamped backup support
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-claudemd-generation/04-CONTEXT.md
@.planning/phases/04-claudemd-generation/04-RESEARCH.md
@.planning/phases/04-claudemd-generation/04-01-SUMMARY.md
@install.sh
@templates/CLAUDE.md.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diff display and existing file handling functions</name>
  <files>install.sh</files>
  <action>
Add two new functions to install.sh, placed after the template processing functions (added in 04-01):

1. **show_colored_diff()** - Display colored unified diff (macOS compatible)
   - Args: existing_file, proposed_file
   - Run `diff -u "$existing" "$proposed"`
   - Colorize output manually (macOS diff lacks --color):
     - `---*` lines in RED
     - `+++*` lines in GREEN
     - `@@*` lines in YELLOW
     - `-*` lines (removals) in RED
     - `+*` lines (additions) in GREEN
     - Other lines unchanged
   - Use while read loop with case statement

2. **handle_existing_claudemd()** - Handle existing CLAUDE.md conflict
   - Args: proposed_file (path to newly generated temp file)
   - Print separator and "CLAUDE.md already exists in this vault."
   - Print "Differences between existing and new:"
   - Call show_colored_diff with "CLAUDE.md" and proposed_file
   - Print separator
   - Prompt for action using existing Gum/read pattern:
     - If HAS_GUM: `gum choose "Keep existing" "Backup and replace" "Replace (no backup)"`
     - Else: numbered menu with read -p
   - Handle each action:
     - "Keep existing": print confirmation, remove proposed file
     - "Backup and replace": create timestamped backup (CLAUDE.md.backup-YYYYMMDD-HHMM), move proposed to CLAUDE.md, print both confirmations
     - "Replace (no backup)": move proposed to CLAUDE.md, print confirmation
   - Use existing color codes for output

Backup naming: `CLAUDE.md.backup-$(date +%Y%m%d-%H%M)`
  </action>
  <verify>
- `grep -c 'show_colored_diff' install.sh` returns 1+
- `grep -c 'handle_existing_claudemd' install.sh` returns 1+
- `grep 'diff -u' install.sh` confirms diff command usage
- `grep 'backup-' install.sh` confirms timestamped backup pattern
- `bash -n install.sh` exits 0
  </verify>
  <done>Diff display and existing file handling functions added with Gum/fallback support</done>
</task>

<task type="auto">
  <name>Task 2: Replace heredoc with template-based CLAUDE.md generation</name>
  <files>install.sh</files>
  <action>
Replace the current CLAUDE.md creation block (lines ~786-878) with template-based generation:

1. **Add vault detection call** (after `cd "$VAULT_DIR"`, around line 738):
   ```bash
   # Detect vault type (new vs existing)
   detect_vault_type
   ```

2. **Replace the entire CLAUDE.md block** (lines 786-878) with:
   ```bash
   # Generate CLAUDE.md from template
   echo ""
   echo "Generating personalized CLAUDE.md..."

   # Check template exists
   if [[ ! -f "$TEMPLATE_DIR/CLAUDE.md.template" ]]; then
       error_exit "Template not found: $TEMPLATE_DIR/CLAUDE.md.template" \
           "Ensure you are running install.sh from the minervia-starter-kit directory"
   fi

   # Generate to temp file first
   TEMP_CLAUDEMD=$(mktemp)
   TEMP_FILES+=("$TEMP_CLAUDEMD")
   process_template "$TEMPLATE_DIR/CLAUDE.md.template" "$TEMP_CLAUDEMD"

   if [[ -f "CLAUDE.md" ]]; then
       # Existing file - show diff and prompt
       handle_existing_claudemd "$TEMP_CLAUDEMD"
   else
       # New file - just move into place
       mv "$TEMP_CLAUDEMD" "CLAUDE.md"
       echo -e "${GREEN}âœ“${NC} CLAUDE.md created"
       echo ""
       echo -e "${YELLOW}!${NC} Edit CLAUDE.md to add your tools and update weekly focus"
   fi
   ```

3. **Update process_template** to ensure proper multi-line substitution:
   - For {{AREAS}} and {{PREFERENCES}}, call format_as_bullets
   - Handle case where user skipped optional fields

4. **Remove the old heredoc block** entirely (the `cat > CLAUDE.md << 'CLAUDEMD'` section)

Important implementation notes:
- Temp file is added to TEMP_FILES array for cleanup on exit
- Template processing happens BEFORE checking for existing file
- VAULT_DIR already set and validated by this point in flow
- detect_vault_type sets IS_NEW_VAULT which can be used by Phase 5
  </action>
  <verify>
Test with both scenarios:
```bash
# Syntax check
bash -n install.sh && echo "Syntax OK"

# Check heredoc is removed
! grep -q "cat > CLAUDE.md << 'CLAUDEMD'" install.sh && echo "Heredoc removed"

# Check template usage
grep 'process_template' install.sh | grep -q 'CLAUDE.md.template' && echo "Template used"

# Check detect_vault_type is called
grep -q 'detect_vault_type' install.sh && echo "Detection called"

# Check handle_existing_claudemd is called
grep -q 'handle_existing_claudemd' install.sh && echo "Conflict handling wired"
```
  </verify>
  <done>Template-based CLAUDE.md generation replaces heredoc, with vault detection and existing file handling</done>
</task>

</tasks>

<verification>
Full integration verification:
```bash
# Syntax check
bash -n install.sh && echo "Syntax OK"

# All new functions exist
grep -c 'show_colored_diff()' install.sh
grep -c 'handle_existing_claudemd()' install.sh
grep -c 'detect_vault_type()' install.sh
grep -c 'process_template()' install.sh

# Heredoc removed
! grep -q "cat > CLAUDE.md << 'CLAUDEMD'" install.sh && echo "Old heredoc removed"

# Template referenced
grep 'CLAUDE.md.template' install.sh

# Flow is wired correctly
grep -A5 'cd "\$VAULT_DIR"' install.sh | grep -q 'detect_vault_type'
grep -B2 -A5 'Generating personalized' install.sh
```
</verification>

<success_criteria>
1. CLAUDE.md generated from template with user answers populated
2. Vault detection runs and displays result to user
3. Existing CLAUDE.md triggers diff display and action menu
4. Backup created with timestamp when selected
5. Old heredoc block completely removed
6. install.sh passes bash syntax check
7. Requirements ONBD-03, ONBD-04, ONBD-05 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-claudemd-generation/04-02-SUMMARY.md`
</output>
