---
phase: 04-claudemd-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/CLAUDE.md.template
  - install.sh
autonomous: true

must_haves:
  truths:
    - "Template file exists at templates/CLAUDE.md.template with {{PLACEHOLDER}} syntax"
    - "Vault detection function correctly identifies new vs existing vault"
    - "Template processing function substitutes all placeholders with user answers"
  artifacts:
    - path: "templates/CLAUDE.md.template"
      provides: "CLAUDE.md template with placeholders"
      contains: "{{NAME}}"
    - path: "install.sh"
      provides: "detect_vault_type and process_template functions"
      contains: "detect_vault_type"
  key_links:
    - from: "process_template"
      to: "ANSWERS array"
      via: "placeholder substitution"
      pattern: "ANSWERS\\[.*\\]"
---

<objective>
Create the template system infrastructure for CLAUDE.md generation

Purpose: Establish the foundation for personalized CLAUDE.md files by creating an external template with placeholder syntax and implementing vault detection and template processing functions.

Output:
- `templates/CLAUDE.md.template` with {{PLACEHOLDER}} syntax
- `detect_vault_type()` function in install.sh
- `escape_for_sed()`, `format_as_bullets()`, `process_template()` functions in install.sh
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-claudemd-generation/04-CONTEXT.md
@.planning/phases/04-claudemd-generation/04-RESEARCH.md
@install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLAUDE.md template file</name>
  <files>templates/CLAUDE.md.template</files>
  <action>
Create `templates/` directory and `CLAUDE.md.template` file with:

1. Placeholder syntax using `{{NAME}}`, `{{ROLE}}`, `{{AREAS}}`, `{{PREFERENCES}}`, `{{DATE}}`
2. Sections:
   - Vault Overview (personalized intro with name and role)
   - Folder Structure (static PARA guidance with edit comments)
   - Current Focus (static placeholder for user to update weekly)
   - Working Preferences ({{PREFERENCES}} as bullet list)
   - Key Contexts ({{AREAS}} as bullet list, plus Tools placeholder)
   - Uncertainty Protocol (static guidance on when Claude should ask vs guess)
3. Guidance comments like `<!-- Update this section when your priorities change -->`
4. Keep personalized content to ~60-80 lines (per research: Claude Code works best with concise CLAUDE.md)

Do NOT include Minervia documentation (skills list, workflow guides) â€” that's reference material, not personal context.

Template structure:
```markdown
# CLAUDE.md

This file provides context to Claude Code when working in this vault.

## Vault Overview
This is {{NAME}}'s personal knowledge management vault using the PARA methodology. I work as a {{ROLE}}.

## Folder Structure
[PARA folder descriptions with edit comments]

## Current Focus
[Placeholder for weekly priorities]

## Working Preferences
{{PREFERENCES}}

## Key Contexts
**Areas I focus on:**
{{AREAS}}

**Tools I Use:**
[Placeholder list]

## Uncertainty Protocol
[Guidance on ask vs guess behavior]

---
*Last updated: {{DATE}}*
```
  </action>
  <verify>
- File exists at templates/CLAUDE.md.template
- Contains all 5 placeholders: {{NAME}}, {{ROLE}}, {{AREAS}}, {{PREFERENCES}}, {{DATE}}
- Under 100 lines
- `grep -c '{{' templates/CLAUDE.md.template` returns 5+
  </verify>
  <done>Template file created with proper placeholder syntax and all required sections</done>
</task>

<task type="auto">
  <name>Task 2: Add vault detection and template processing functions</name>
  <files>install.sh</files>
  <action>
Add three new functions to install.sh, placed after the platform detection section (around line 619) and before the prerequisite checks section:

1. **detect_vault_type()** - Determine if vault is new or existing
   - Use nullglob to check for non-hidden files: `shopt -s nullglob; files=("$VAULT_DIR"/*); shopt -u nullglob`
   - Set global `IS_NEW_VAULT=true` if no files found, else `IS_NEW_VAULT=false`
   - Print detection result: "${GREEN}Detected:${NC} New vault (empty directory)" or "${YELLOW}Detected:${NC} Existing vault (N visible items)"
   - Export IS_NEW_VAULT for potential use in Phase 5

2. **escape_for_sed()** - Escape special sed characters in user input
   - Escape: & / \ characters
   - `printf '%s' "$1" | sed -e 's/[&/\]/\\&/g'`

3. **format_as_bullets()** - Convert comma-separated values to markdown bullet list
   - Args: csv_string, default_placeholder
   - If empty, return the default placeholder
   - Split on comma, trim whitespace, prefix each with "- "
   - Example: "Content Creation,Research" -> "- Content Creation\n- Research"

4. **process_template()** - Process template file with user answers
   - Args: template_file, output_file
   - Read template content
   - Use `#` as sed delimiter to avoid path conflicts
   - Substitute simple placeholders: {{NAME}}, {{ROLE}}, {{DATE}}
   - For {{DATE}}, use `$(date +%Y-%m-%d)`
   - Handle empty values gracefully with defaults like "[Your role]"
   - For multi-value fields ({{AREAS}}, {{PREFERENCES}}), use awk for multi-line substitution
   - Write to output file

Reference existing patterns:
- Use existing color codes (GREEN, YELLOW, RED, NC)
- Use existing portable_date() if helpful
- Follow existing function naming conventions

Also add `TEMPLATE_DIR="$(dirname "$0")/templates"` near SKILLS_SOURCE definition (around line 727).
  </action>
  <verify>
- `grep -c 'detect_vault_type' install.sh` returns 1+
- `grep -c 'escape_for_sed' install.sh` returns 1+
- `grep -c 'format_as_bullets' install.sh` returns 1+
- `grep -c 'process_template' install.sh` returns 1+
- `grep -c 'TEMPLATE_DIR' install.sh` returns 1+
- `bash -n install.sh` exits 0 (syntax check passes)
  </verify>
  <done>Four template processing functions added and install.sh passes syntax check</done>
</task>

</tasks>

<verification>
All verification checks should pass:
```bash
# Template file
test -f templates/CLAUDE.md.template && echo "Template exists"
grep -c '{{' templates/CLAUDE.md.template  # Should be 5+

# Functions in install.sh
grep 'detect_vault_type()' install.sh
grep 'escape_for_sed()' install.sh
grep 'format_as_bullets()' install.sh
grep 'process_template()' install.sh
grep 'TEMPLATE_DIR=' install.sh

# Syntax check
bash -n install.sh && echo "Syntax OK"
```
</verification>

<success_criteria>
1. Template file exists at `templates/CLAUDE.md.template` with 5 placeholders
2. Four new functions added to install.sh (detect_vault_type, escape_for_sed, format_as_bullets, process_template)
3. TEMPLATE_DIR variable defined
4. install.sh passes bash syntax check
5. All verification commands succeed
</success_criteria>

<output>
After completion, create `.planning/phases/04-claudemd-generation/04-01-SUMMARY.md`
</output>
