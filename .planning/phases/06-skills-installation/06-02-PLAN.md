---
phase: 06-skills-installation
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified: [install.sh]
autonomous: true

must_haves:
  truths:
    - "installer prompts user when skill/agent file already exists"
    - "user can choose: keep existing, overwrite, or backup + overwrite"
    - "unchanged files are skipped without prompt (MD5 comparison)"
    - "agents are installed to ~/.claude/agents/"
    - "all installed files are recorded in state.json with checksums"
    - "state.json is initialized before any file installation"
  artifacts:
    - path: "install.sh"
      provides: "install_skill_file(), install_agent_file(), install_skills(), install_agents() functions"
      contains: "install_agents"
    - path: "~/.minervia/state.json"
      provides: "Installation state with file manifest"
  key_links:
    - from: "install_skill_file"
      to: "record_installed_file"
      via: "function call after successful copy"
      pattern: "record_installed_file"
    - from: "install.sh main"
      to: "install_skills, install_agents"
      via: "sequential calls in main flow"
      pattern: "install_skills.*install_agents"
---

<objective>
Refactor skill/agent installation with proper conflict handling and state tracking.

Purpose: Replace the existing simple skill copy with checksum-aware installation that tracks state and handles conflicts interactively. Add agent installation following the same pattern.

Output: install.sh with complete skill/agent installation including conflict resolution and state.json tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-skills-installation/06-CONTEXT.md
@.planning/phases/06-skills-installation/06-01-SUMMARY.md

@install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file-level installation function with conflict handling</name>
  <files>install.sh</files>
  <action>
Add `install_single_file()` function in the Skills Installation section. This handles one file with conflict detection:

Arguments: source_path, target_path, display_name

Logic:
1. If target doesn't exist:
   - Copy source to target
   - Call record_installed_file
   - Print green checkmark with display_name
   - Return 0 (installed)

2. If target exists:
   - Compute MD5 of both source and target
   - If MD5s match: print yellow skip message "unchanged", return 1 (skipped)
   - If MD5s differ: call `handle_file_conflict()` (defined next)

Add `handle_file_conflict()` function:
Arguments: source_path, target_path, display_name

Logic:
1. Print warning that file differs
2. Show diff using show_colored_diff (already exists in install.sh)
3. Prompt user with ask_choice (already exists):
   - "Keep existing"
   - "Backup and replace"
   - "Replace (no backup)"
4. Handle each option:
   - Keep: print message, return 1 (skipped)
   - Backup + replace: mv target to target.backup-TIMESTAMP, cp source to target, record_installed_file, return 0
   - Replace: cp source to target, record_installed_file, return 0

Note: Reuse existing ask_choice and show_colored_diff functions. The pattern matches handle_existing_claudemd().
  </action>
  <verify>
Bash syntax: `bash -n install.sh`
Functions exist: `grep -c "install_single_file\|handle_file_conflict" install.sh` returns 2+
  </verify>
  <done>
install_single_file and handle_file_conflict functions handle copy with conflict detection
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor skill installation to use new functions</name>
  <files>install.sh</files>
  <action>
Replace the existing skill installation loop (lines ~1196-1229) with a new `install_skills()` function:

1. Create AGENTS_SOURCE variable (similar to SKILLS_SOURCE): `AGENTS_SOURCE="$(dirname "$0")/agents"`

2. Create `install_skills()` function:
   - Initialize counters: installed=0, skipped=0, failed=0
   - Loop through each skill directory in SKILLS_SOURCE
   - For each skill, loop through files (currently just SKILL.md, but future-proof for multiple files)
   - Call install_single_file for each file
   - Track counters based on return value
   - Print summary at end: "Skills: X installed, Y unchanged, Z failed"

3. Create `install_agents()` function following same pattern:
   - Check if AGENTS_SOURCE directory exists (graceful if no agents yet)
   - Loop through agent directories
   - Target is ~/.claude/agents/
   - Same counter and summary pattern

4. Update main flow:
   - Call init_state_file() before installation begins
   - Replace inline skill loop with install_skills()
   - Add install_agents() call after install_skills()
   - Remove old skills_installed/skills_skipped tracking

5. Update --help text to mention agents are also installed.
  </action>
  <verify>
Bash syntax: `bash -n install.sh`
Functions exist: `grep "install_skills\|install_agents" install.sh`
init_state_file called: `grep "init_state_file" install.sh`
Old loop removed: Confirm no more "for skill_dir in" outside of install_skills function
  </verify>
  <done>
Skill installation refactored to install_skills(), agent installation added as install_agents(), state.json initialized, help text updated
  </done>
</task>

</tasks>

<verification>
1. Bash syntax: `bash -n install.sh` passes
2. State initialized: `grep -n "init_state_file" install.sh` shows call in main flow
3. Skills function: `grep -n "install_skills" install.sh` shows function and call
4. Agents function: `grep -n "install_agents" install.sh` shows function and call
5. Conflict handling: `grep -n "handle_file_conflict" install.sh` shows function exists
6. Help updated: `grep -i "agent" install.sh | head -5` shows mention in help
</verification>

<success_criteria>
- Skill installation uses checksum comparison to skip unchanged files
- File conflicts prompt user for action (keep/backup+replace/replace)
- Agents install to ~/.claude/agents/ following same pattern
- state.json is initialized and populated with all installed files
- Help text reflects agent installation
- Existing functionality preserved (CLAUDE.md generation, scaffolding, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/06-skills-installation/06-02-SUMMARY.md`
</output>
